# XXX + slp
# XXX + valgrind
[tox]
envlist =
    {py27d,py27,py36,py37d,py37,pypy,pypy3}-{thread,gevent}
# XXX under pypy tsan somehow does not observe the GIL lock/release, and this
# way reports even plain T1.Py_INCREF / T2.Py_DECREF as a race.
    {py27d,py27,py36,py37d,py37           }-{thread,gevent}-tsan
# XXX asan does not work with gevent: https://github.com/python-greenlet/greenlet/issues/113
    {py27d,py27,py36,py37d,py37,pypy,pypy3}-{thread       }-asan

[testenv]
basepython =
    py27d:  python2.7-dbg
    py27:   python2.7
    py36:   python3.6
    py37d:  python3.7-dbg
    py37:   python3.7
    pypy:   pypy
    pypy3:  pypy3

setenv =
# distutils take CFLAGS for both C and C++.
# distutils use  CFLAGS also at link stage -> we don't need to set LDFLAGS separately.
    tsan: CFLAGS=-g -fsanitize=thread
    asan: CFLAGS=-g -fsanitize=address
# XXX however distutils' try_link, which is used by numpy.distutils use only CC
# as linker without CFLAGS and _without_ LDFLAGS, which fails if *.o were
# compiled with -fsanitize=X and linked without that option. Work it around
# with also adjusting CC.
# XXX or better arrange to using CFLAGS on pygolang build only?
    tsan: CC=cc -fsanitize=thread
    asan: CC=cc -fsanitize=address

# always compile pygolang from source and don't reuse binary pygolang wheels as
# we compile each case with different CFLAGS.
install_command =
    python -m pip install --no-binary pygolang {opts} {packages}

deps    =
    .[all]

# gpython pre-imports installed golang, will get into conflict with
# golang/ if we run pytest from pygolang worktree. Avoid that.
changedir = {envsitepackagesdir}

# pypy: `--jit off` ? (bytecode patch test does not pass on pypy)
# XXX toxinidir ok? (not good - better use from untarred sdist)
commands=
    {toxinidir}/trun        \
    thread: {envpython}     \
    gevent: gpython         \
        -m pytest           \
# asan/tsan: tell pytest not to capture output - else it is not possible to see
# reports from sanitizers because they crash tested process on error.
# likewise for python debug builds.
        asan,tsan,py{27,37}d: -s    \
        gpython/ golang/
